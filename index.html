<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Produk</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-4xl mx-auto py-8">
    <h1 class="text-2xl font-bold mb-6 text-center text-[#349b11]">ðŸ“¦ Admin Produk</h1>

    <!-- Form Tambah Produk -->
    <form id="produkForm" class="bg-white p-6 rounded-lg shadow space-y-4">
      <input type="text" id="nama" placeholder="Nama Produk" class="w-full border p-2 rounded" required>
      <textarea id="deskripsi" placeholder="Deskripsi Produk" class="w-full border p-2 rounded"></textarea>
      <input type="number" id="harga" placeholder="Harga Jual" class="w-full border p-2 rounded" required>
      <input type="number" id="diskon" placeholder="Harga Diskon (opsional)" class="w-full border p-2 rounded">
      <select id="kategori" class="w-full border p-2 rounded" required>
        <option value="best">Best Seller</option>
        <option value="madu">Madu</option>
        <option value="herbal">Herbal Lain</option>
      </select>
      <input type="file" id="gambar" accept="image/*" class="w-full border p-2 rounded" required>

      <button type="submit" class="w-full bg-[#349b11] text-white py-2 rounded hover:bg-[#017100] transition">
        Simpan Produk
      </button>
    </form>

    <!-- Daftar Produk -->
    <h2 class="text-xl font-bold mt-10 mb-4">ðŸ“‹ Daftar Produk</h2>
    <div id="produkList" class="grid md:grid-cols-2 gap-4"></div>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyx3hfM_49dQPWrYeKBuZ_5umRPGvTjLI",
      authDomain: "greciaexperiment.firebaseapp.com",
      projectId: "greciaexperiment",
      storageBucket: "greciaexperiment.appspot.com",
      messagingSenderId: "449936532510",
      appId: "1:449936532510:web:9186754bceb92884c63a0f",
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const form = document.getElementById("produkForm");
    const produkList = document.getElementById("produkList");

    // Upload Gambar ke ImageKit
    async function uploadImage(file) {
      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.readAsDataURL(file);
        reader.onload = async () => {
          const base64 = reader.result.split(",")[1];
          const res = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
            method: "POST",
            headers: {
              Authorization: "Basic " + btoa("public_QHOqYWEUs10NYDE/kURbKvBmulQ=:"),
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              file: base64,
              fileName: file.name
            })
          });
          const data = await res.json();
          resolve(data.url);
        };
        reader.onerror = reject;
      });
    }

    // Tambah Produk
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama").value;
      const deskripsi = document.getElementById("deskripsi").value;
      const harga = parseInt(document.getElementById("harga").value);
      const diskon = parseInt(document.getElementById("diskon").value) || null;
      const kategori = document.getElementById("kategori").value;
      const file = document.getElementById("gambar").files[0];

      let urlGambar = "";
      if (file) urlGambar = await uploadImage(file);

      await addDoc(collection(db, "produk"), {
        nama, deskripsi, harga_jual: harga, harga_diskon: diskon, kategori, gambar: urlGambar
      });

      form.reset();
      loadProduk();
    });

    // Load Produk
    async function loadProduk() {
      produkList.innerHTML = "";
      const snap = await getDocs(collection(db, "produk"));
      snap.forEach(docSnap => {
        const p = docSnap.data();
        const id = docSnap.id;
        produkList.innerHTML += `
          <div class="bg-white p-4 rounded shadow">
            <img src="${p.gambar}" class="w-full h-40 object-cover rounded">
            <h3 class="font-bold mt-2">${p.nama}</h3>
            <p class="text-sm text-gray-500">${p.deskripsi || ""}</p>
            <p class="text-green-600 font-bold">Rp ${p.harga_diskon ? p.harga_diskon.toLocaleString() : p.harga_jual.toLocaleString()}</p>
            <div class="flex space-x-2 mt-2">
              <button onclick="hapusProduk('${id}')" class="bg-red-500 text-white px-3 py-1 rounded">Hapus</button>
            </div>
          </div>
        `;
      });
    }

    // Hapus Produk
    window.hapusProduk = async (id) => {
      await deleteDoc(doc(db, "produk", id));
      loadProduk();
    };

    loadProduk();
  </script>
</body>
</html>
