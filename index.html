<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Produk</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-4xl mx-auto py-8">
    <h1 class="text-3xl font-bold mb-6">ðŸ“¦ Admin Produk</h1>

    <!-- Form tambah / edit produk -->
    <form id="produkForm" class="bg-white shadow rounded-xl p-6 mb-8">
      <input type="hidden" id="produkId">

      <div class="mb-4">
        <label class="block font-medium">Nama Produk</label>
        <input type="text" id="nama" class="w-full border rounded-lg p-2">
      </div>

      <div class="mb-4">
        <label class="block font-medium">Deskripsi</label>
        <textarea id="deskripsi" class="w-full border rounded-lg p-2"></textarea>
      </div>

      <div class="mb-4">
        <label class="block font-medium">Harga Jual</label>
        <input type="number" id="harga_jual" class="w-full border rounded-lg p-2">
      </div>

      <div class="mb-4">
        <label class="block font-medium">Harga Diskon (opsional)</label>
        <input type="number" id="harga_diskon" class="w-full border rounded-lg p-2">
      </div>

      <div class="mb-4">
        <label class="block font-medium">Kategori</label>
        <select id="kategori" class="w-full border rounded-lg p-2">
          <option value="best">Best Seller</option>
          <option value="madu">Madu</option>
          <option value="herbal">Herbal Lain</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="block font-medium">Gambar Produk</label>
        <input type="file" id="gambar" class="w-full">
        <img id="preview" class="mt-2 rounded-lg max-h-40 hidden">
      </div>

      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
        Simpan Produk
      </button>
    </form>

    <!-- List Produk -->
    <h2 class="text-2xl font-bold mb-4">ðŸ“‹ Daftar Produk</h2>
    <div id="produkList" class="grid gap-4"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ðŸ”‘ Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDyx3hfM_49dQPWrYeKBuZ_5umRPGvTjLI",
      authDomain: "greciaexperiment.firebaseapp.com",
      projectId: "greciaexperiment",
      storageBucket: "greciaexperiment.firebasestorage.app",
      messagingSenderId: "449936532510",
      appId: "1:449936532510:web:9186754bceb92884c63a0f",
      measurementId: "G-5R08SBGN4N"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ðŸ”‘ Imgur Client-ID
    const IMGUR_CLIENT_ID = "YOUR_IMGUR_CLIENT_ID"; // ganti dengan Client-ID dari Imgur

    const produkForm = document.getElementById("produkForm");
    const produkList = document.getElementById("produkList");
    const preview    = document.getElementById("preview");

    // ðŸ“Œ Upload gambar ke Imgur
    async function uploadToImgur(file) {
      let formData = new FormData();
      formData.append("image", file);
      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: { Authorization: "Client-ID " + IMGUR_CLIENT_ID },
        body: formData
      });
      const data = await res.json();
      return data.data.link;
    }

    // ðŸ“Œ Render daftar produk
    async function loadProduk() {
      produkList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "produk"));
      snapshot.forEach(docSnap => {
        const p = docSnap.data();
        produkList.innerHTML += `
          <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <img src="${p.gambar}" class="w-20 h-20 rounded-lg object-cover">
              <div>
                <h3 class="font-bold">${p.nama}</h3>
                <p class="text-sm text-gray-500">${p.kategori}</p>
                <p class="text-green-600">Rp ${p.harga_diskon || p.harga_jual}</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="editProduk('${docSnap.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">Edit</button>
              <button onclick="hapusProduk('${docSnap.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Hapus</button>
            </div>
          </div>
        `;
      });
    }

    // ðŸ“Œ Tambah / Update produk
    produkForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("produkId").value;
      const nama = document.getElementById("nama").value;
      const deskripsi = document.getElementById("deskripsi").value;
      const harga_jual = parseInt(document.getElementById("harga_jual").value);
      const harga_diskon = parseInt(document.getElementById("harga_diskon").value) || null;
      const kategori = document.getElementById("kategori").value;
      let gambarUrl = preview.src || "";

      // Kalau ada file baru â†’ upload ke imgur
      const file = document.getElementById("gambar").files[0];
      if (file) {
        gambarUrl = await uploadToImgur(file);
      }

      const data = { nama, deskripsi, harga_jual, harga_diskon, kategori, gambar: gambarUrl };

      if (id) {
        await updateDoc(doc(db, "produk", id), data);
      } else {
        await addDoc(collection(db, "produk"), data);
      }

      produkForm.reset();
      preview.src = "";
      preview.classList.add("hidden");
      document.getElementById("produkId").value = "";
      loadProduk();
    });

    // ðŸ“Œ Edit produk
    window.editProduk = async (id) => {
      const snapshot = await getDocs(collection(db, "produk"));
      snapshot.forEach(docSnap => {
        if (docSnap.id === id) {
          const p = docSnap.data();
          document.getElementById("produkId").value = id;
          document.getElementById("nama").value = p.nama;
          document.getElementById("deskripsi").value = p.deskripsi;
          document.getElementById("harga_jual").value = p.harga_jual;
          document.getElementById("harga_diskon").value = p.harga_diskon || "";
          document.getElementById("kategori").value = p.kategori;
          preview.src = p.gambar;
          preview.classList.remove("hidden");
        }
      });
    };

    // ðŸ“Œ Hapus produk
    window.hapusProduk = async (id) => {
      await deleteDoc(doc(db, "produk", id));
      loadProduk();
    };

    // ðŸ“Œ Preview gambar saat pilih file
    document.getElementById("gambar").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          preview.src = reader.result;
          preview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // ðŸš€ Load awal
    loadProduk();
  </script>
</body>
</html>
